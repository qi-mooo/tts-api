<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS 管理控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="/static/js/mobile-detector.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
        }
        .sidebar .nav-link {
            color: #adb5bd;
        }
        .sidebar .nav-link:hover {
            color: #fff;
        }
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #495057;
        }
        .main-content {
            padding: 20px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #28a745;
        }
        .status-warning {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .btn-preview {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }
        .btn-preview:hover {
            background-color: #138496;
            border-color: #117a8b;
            color: white;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-level-INFO {
            color: #0d6efd;
        }
        .log-level-WARNING {
            color: #fd7e14;
        }
        .log-level-ERROR {
            color: #dc3545;
        }
        .log-level-DEBUG {
            color: #6c757d;
        }
        
        /* 移动端优化样式 */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 1050;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .mobile-nav-toggle {
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1060;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px;
                font-size: 18px;
            }
            
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1040;
                display: none;
            }
            
            .mobile-overlay.show {
                display: block;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .btn-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-toolbar .btn {
                width: 100%;
            }
            
            .table-responsive {
                font-size: 14px;
            }
            
            .login-container {
                padding: 20px;
            }
            
            .login-card {
                margin: 0 10px;
            }
        }
        
        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
        
        /* 触摸设备优化 */
        .touch-device .btn {
            min-height: 44px;
            padding: 12px 16px;
        }
        
        .touch-device .nav-link {
            padding: 12px 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .touch-device .form-control {
            min-height: 44px;
            padding: 12px 16px;
        }
        
        .touch-device .btn:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    </style>
</head>
<body>
    <!-- 移动端导航按钮 -->
    <button class="mobile-nav-toggle d-md-none" onclick="toggleMobileSidebar()">
        <i class="bi bi-list"></i>
    </button>
    
    <!-- 移动端遮罩层 -->
    <div class="mobile-overlay" onclick="closeMobileSidebar()"></div>
    
    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-soundwave display-4 text-primary"></i>
                    <h3 class="mt-2">TTS 管理控制台</h3>
                    <p class="text-muted">请登录以继续</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-box-arrow-in-right me-2"></i>登录
                    </button>
                </form>
                <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainApp" class="d-none">
        <div class="container-fluid">
            <div class="row">
                <!-- 侧边栏 -->
                <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                    <div class="position-sticky pt-3">
                        <div class="text-center mb-4">
                            <i class="bi bi-soundwave text-light display-6"></i>
                            <h5 class="text-light mt-2">TTS 控制台</h5>
                        </div>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-page="dashboard">
                                    <i class="bi bi-speedometer2 me-2"></i>仪表板
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-page="config">
                                    <i class="bi bi-gear me-2"></i>配置管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-page="dictionary">
                                    <i class="bi bi-book me-2"></i>字典管理
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-page="settings">
                                    <i class="bi bi-gear me-2"></i>个人设置
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-page="logs">
                                    <i class="bi bi-file-text me-2"></i>日志查看
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-page="system">
                                    <i class="bi bi-cpu me-2"></i>系统监控
                                </a>
                            </li>
                        </ul>
                        <hr class="text-light">
                        <div class="dropdown">
                            <a href="#" class="d-flex align-items-center text-light text-decoration-none dropdown-toggle" 
                               id="dropdownUser" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-2"></i>
                                <span id="currentUser">管理员</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                                <li><a class="dropdown-item" href="#" data-page="profile">
                                    <i class="bi bi-person me-2"></i>个人设置
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-2"></i>退出登录
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- 主内容区域 -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <!-- 仪表板页面 -->
                    <div id="dashboardPage" class="page-content">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">仪表板</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                </button>
                            </div>
                        </div>

                        <!-- 系统状态卡片 -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-left-primary shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                    系统运行时间
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="systemUptime">
                                                    加载中...
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="bi bi-clock text-primary" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-left-success shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                    内存使用率
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="memoryUsage">
                                                    加载中...
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="bi bi-memory text-success" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-left-info shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                    CPU 使用率
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="cpuUsage">
                                                    加载中...
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="bi bi-cpu text-info" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card border-left-warning shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                    Edge-TTS 状态
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="edgeTtsStatus">
                                                    <span class="status-indicator status-healthy"></span>正常
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="bi bi-soundwave text-warning" style="font-size: 2rem;"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 配置摘要 -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-gear me-2"></i>当前配置
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="configSummary">
                                            <p>加载中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 mb-4">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-book me-2"></i>字典统计
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="dictionaryStats">
                                            <p>加载中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> 
                   <!-- 配置管理页面 -->
                    <div id="configPage" class="page-content d-none">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">配置管理</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-success" onclick="saveConfig()">
                                    <i class="bi bi-check-circle me-1"></i>保存配置
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="loadConfig()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>重新加载
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <!-- TTS 配置 -->
                            <div class="col-lg-6 mb-4">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-soundwave me-2"></i>语音参数配置
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="ttsConfigForm">
                                            <!-- 语言选择 -->
                                            <div class="mb-3">
                                                <label for="adminCountrySelect" class="form-label">
                                                    <i class="bi bi-globe me-1"></i>选择语言
                                                </label>
                                                <select class="form-select" id="adminCountrySelect" name="country" onchange="updateAdminVoices()">
                                                    <option value="">请选择语言</option>
                                                    <option value="zh">中文</option>
                                                    <option value="en">English</option>
                                                    <option value="ja">日本語</option>
                                                    <option value="ko">한국어</option>
                                                    <option value="fr">Français</option>
                                                    <option value="de">Deutsch</option>
                                                    <option value="es">Español</option>
                                                    <option value="it">Italiano</option>
                                                    <option value="pt">Português</option>
                                                    <option value="ru">Русский</option>
                                                    <option value="ar">العربية</option>
                                                    <option value="hi">हिन्दी</option>
                                                    <option value="th">ไทย</option>
                                                    <option value="vi">Tiếng Việt</option>
                                                    <option value="tr">Türkçe</option>
                                                    <option value="pl">Polski</option>
                                                    <option value="nl">Nederlands</option>
                                                    <option value="sv">Svenska</option>
                                                    <option value="cs">Čeština</option>
                                                    <option value="hu">Magyar</option>
                                                    <option value="uk">Українська</option>
                                                    <option value="ms">Bahasa Melayu</option>
                                                    <option value="id">Bahasa Indonesia</option>
                                                    <option value="kk">Қазақ тілі</option>
                                                </select>
                                                <div class="form-text">选择语言后将显示对应的语音选项</div>
                                            </div>
                                            
                                            <!-- 语音类型选择 -->
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="bi bi-mic me-1"></i>语音配置模式
                                                </label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="adminVoiceMode" id="adminSingleVoice" value="single" checked onchange="toggleAdminVoiceMode()">
                                                    <label class="form-check-label" for="adminSingleVoice">
                                                        统一语音模式
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="adminVoiceMode" id="adminMultiVoice" value="multi" onchange="toggleAdminVoiceMode()">
                                                    <label class="form-check-label" for="adminMultiVoice">
                                                        旁白对话分离模式
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- 统一语音选择 -->
                                            <div id="adminSingleVoiceSection" class="mb-3">
                                                <label for="adminUnifiedVoice" class="form-label">统一语音</label>
                                                <select class="form-select" id="adminUnifiedVoice" name="unified_voice">
                                                    <option value="">请先选择语言</option>
                                                </select>
                                                <div class="form-text">所有文本将使用此语音</div>
                                            </div>
                                            
                                            <!-- 分离语音选择 -->
                                            <div id="adminMultiVoiceSection" class="d-none">
                                                <div class="mb-3">
                                                    <label for="narrationVoice" class="form-label">
                                                        <i class="bi bi-person-lines-fill me-1"></i>旁白语音
                                                    </label>
                                                    <select class="form-select" id="narrationVoice" name="narration_voice">
                                                        <option value="">请先选择语言</option>
                                                    </select>
                                                    <div class="form-text">用于叙述性文本</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="dialogueVoice" class="form-label">
                                                        <i class="bi bi-chat-quote me-1"></i>对话语音
                                                    </label>
                                                    <select class="form-select" id="dialogueVoice" name="dialogue_voice">
                                                        <option value="">请先选择语言</option>
                                                    </select>
                                                    <div class="form-text">用于引号内的对话文本</div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="defaultSpeed" class="form-label">默认语速</label>
                                                <input type="number" class="form-control" id="defaultSpeed" name="default_speed" 
                                                       min="0.5" max="3.0" step="0.1" value="1.2">
                                                <div class="form-text">语速范围：0.5 - 3.0</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cacheSizeLimit" class="form-label">缓存大小限制 (字节)</label>
                                                <input type="number" class="form-control" id="cacheSizeLimit" name="cache_size_limit" 
                                                       value="10485760">
                                                <div class="form-text">默认：10MB (10485760 字节)</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cacheTimeLimit" class="form-label">缓存时间限制 (秒)</label>
                                                <input type="number" class="form-control" id="cacheTimeLimit" name="cache_time_limit" 
                                                       value="1200">
                                                <div class="form-text">默认：20分钟 (1200 秒)</div>
                                            </div>
                                        </form>
                                        
                                        <!-- 语音预览 -->
                                        <div class="mt-4">
                                            <h6><i class="bi bi-play-circle me-1"></i>语音预览</h6>
                                            <div class="mb-3">
                                                <label for="previewText" class="form-label">预览文本</label>
                                                <input type="text" class="form-control" id="previewText" 
                                                       placeholder="输入要预览的文本" value="他说'你好世界'然后离开了">
                                                <div class="form-text">使用默认文本可以同时测试旁白和对话语音</div>
                                            </div>
                                            <div class="btn-group w-100 mb-2" role="group">
                                                <button class="btn btn-outline-primary" type="button" onclick="previewAdminVoice('narration')">
                                                    <i class="bi bi-person-lines-fill me-1"></i>预览旁白
                                                </button>
                                                <button class="btn btn-outline-success" type="button" onclick="previewAdminVoice('dialogue')">
                                                    <i class="bi bi-chat-quote me-1"></i>预览对话
                                                </button>
                                                <button class="btn btn-outline-info" type="button" onclick="previewAdminVoice('unified')">
                                                    <i class="bi bi-mic me-1"></i>预览统一
                                                </button>
                                            </div>
                                            <audio id="previewAudio" controls class="w-100 d-none"></audio>
                                            <div id="previewStatus" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 系统配置 -->
                            <div class="col-lg-6 mb-4">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-gear me-2"></i>系统设置
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="systemConfigForm">
                                            <div class="mb-3">
                                                <label for="systemHost" class="form-label">服务器地址</label>
                                                <input type="text" class="form-control" id="systemHost" name="host" value="0.0.0.0">
                                            </div>
                                            <div class="mb-3">
                                                <label for="systemPort" class="form-label">端口号</label>
                                                <input type="number" class="form-control" id="systemPort" name="port" 
                                                       min="1" max="65535" value="5000">
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="systemDebug" name="debug">
                                                    <label class="form-check-label" for="systemDebug">
                                                        调试模式
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="maxWorkers" class="form-label">最大工作线程数</label>
                                                <input type="number" class="form-control" id="maxWorkers" name="max_workers" 
                                                       min="1" max="20" value="5">
                                            </div>
                                        </form>

                                        <!-- 日志配置 -->
                                        <hr>
                                        <h6>日志配置</h6>
                                        <form id="loggingConfigForm">
                                            <div class="mb-3">
                                                <label for="logLevel" class="form-label">日志级别</label>
                                                <select class="form-select" id="logLevel" name="level">
                                                    <option value="DEBUG">DEBUG</option>
                                                    <option value="INFO" selected>INFO</option>
                                                    <option value="WARNING">WARNING</option>
                                                    <option value="ERROR">ERROR</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="logFile" class="form-label">日志文件路径</label>
                                                <input type="text" class="form-control" id="logFile" name="file" 
                                                       value="logs/app.log">
                                            </div>
                                            <div class="mb-3">
                                                <label for="logMaxSize" class="form-label">日志文件最大大小</label>
                                                <input type="text" class="form-control" id="logMaxSize" name="max_size" 
                                                       value="10MB">
                                            </div>
                                            <div class="mb-3">
                                                <label for="logBackupCount" class="form-label">备份文件数量</label>
                                                <input type="number" class="form-control" id="logBackupCount" name="backup_count" 
                                                       min="1" max="10" value="5">
                                            </div>
                                        </form>

                                        <!-- 字典配置 -->
                                        <hr>
                                        <h6>字典配置</h6>
                                        <form id="dictionaryConfigForm">
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="dictionaryEnabled" name="enabled" checked>
                                                    <label class="form-check-label" for="dictionaryEnabled">
                                                        启用字典功能
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="rulesFile" class="form-label">规则文件路径</label>
                                                <input type="text" class="form-control" id="rulesFile" name="rules_file" 
                                                       value="dictionary/rules.json">
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 字典管理页面 -->
                    <div id="dictionaryPage" class="page-content d-none">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">字典管理</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                                    <i class="bi bi-plus-circle me-1"></i>添加规则
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="loadDictionaryRules()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" data-bs-toggle="modal" data-bs-target="#importRulesModal">
                                    <i class="bi bi-upload me-1"></i>导入
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="exportDictionaryRules()">
                                    <i class="bi bi-download me-1"></i>导出
                                </button>
                            </div>
                        </div>

                        <!-- 规则过滤器 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="ruleSearch" placeholder="搜索规则...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="ruleTypeFilter">
                                    <option value="">所有类型</option>
                                    <option value="pronunciation">发音替换</option>
                                    <option value="filter">内容过滤</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="ruleStatusFilter">
                                    <option value="">所有状态</option>
                                    <option value="enabled">已启用</option>
                                    <option value="disabled">已禁用</option>
                                </select>
                            </div>
                        </div>

                        <!-- 规则列表 -->
                        <div class="card shadow">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>类型</th>
                                                <th>匹配模式</th>
                                                <th>替换内容</th>
                                                <th>状态</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rulesTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center">加载中...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>       
             <!-- 日志查看页面 -->
                    <div id="logsPage" class="page-content d-none">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">日志查看</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadLogs()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="clearTimeFilters()">
                                        <i class="bi bi-x-circle me-1"></i>清空时间
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickTimeRange(1)">
                                        最近1小时
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickTimeRange(6)">
                                        最近6小时
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickTimeRange(24)">
                                        最近24小时
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 日志过滤器 -->
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="logTypeFilter" class="form-label">日志类别</label>
                                <select class="form-select" id="logTypeFilter" onchange="loadLogs()">
                                    <option value="audio" selected>音频请求</option>
                                    <option value="ALL">所有类别</option>
                                    <option value="http">HTTP请求</option>
                                    <option value="api">API调用</option>
                                    <option value="error">错误日志</option>
                                    <option value="audit">审计日志</option>
                                    <option value="performance">性能日志</option>
                                    <option value="general">一般日志</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="logLevelFilter" class="form-label">日志级别</label>
                                <select class="form-select" id="logLevelFilter" onchange="loadLogs()">
                                    <option value="ALL">所有级别</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="logLines" class="form-label">显示行数</label>
                                <select class="form-select" id="logLines" onchange="loadLogs()">
                                    <option value="50">50 行</option>
                                    <option value="100" selected>100 行</option>
                                    <option value="200">200 行</option>
                                    <option value="500">500 行</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="logSearch" class="form-label">搜索关键词</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="logSearch" placeholder="输入搜索关键词...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadLogs()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">时间范围</label>
                                <div class="input-group">
                                    <input type="datetime-local" class="form-control" id="logStartTime" onchange="loadLogs()">
                                    <span class="input-group-text">至</span>
                                    <input type="datetime-local" class="form-control" id="logEndTime" onchange="loadLogs()">
                                </div>
                            </div>
                        </div>

                        <!-- 日志统计信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <div class="row text-center">
                                            <div class="col-md-2">
                                                <small class="text-muted">总条数</small>
                                                <div class="fw-bold" id="logStatsTotal">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <small class="text-muted">已过滤</small>
                                                <div class="fw-bold" id="logStatsFiltered">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <small class="text-muted">显示中</small>
                                                <div class="fw-bold" id="logStatsDisplayed">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">类型分布</small>
                                                <div class="fw-bold" id="logStatsTypes">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">级别分布</small>
                                                <div class="fw-bold" id="logStatsLevels">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 日志显示区域 -->
                        <div class="card shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0">
                                    <i class="bi bi-file-text me-2"></i>系统日志
                                </h6>
                                <small class="text-muted" id="logTimestamp">最后更新：--</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="log-container" id="logContainer">
                                    <div class="text-center text-muted p-3">
                                        点击刷新按钮加载日志
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统监控页面 -->
                    <div id="systemPage" class="page-content d-none">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">系统监控</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadSystemStatus()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>刷新状态
                                </button>
                                <button type="button" class="btn btn-sm btn-warning ms-2" onclick="restartSystem()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>重启系统
                                </button>
                            </div>
                        </div>

                        <!-- 系统状态详情 -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-info-circle me-2"></i>系统信息
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-borderless">
                                                    <tr>
                                                        <td><strong>运行时间：</strong></td>
                                                        <td id="detailUptime">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>内存使用：</strong></td>
                                                        <td id="detailMemory">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>CPU 使用率：</strong></td>
                                                        <td id="detailCpu">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>磁盘使用：</strong></td>
                                                        <td id="detailDisk">--</td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <table class="table table-borderless">
                                                    <tr>
                                                        <td><strong>Edge-TTS 状态：</strong></td>
                                                        <td id="detailEdgeTts">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>活跃会话：</strong></td>
                                                        <td id="detailSessions">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>配置更新时间：</strong></td>
                                                        <td id="detailConfigTime">--</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>系统版本：</strong></td>
                                                        <td>v1.0.0</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-activity me-2"></i>实时监控
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">内存使用率</label>
                                            <div class="progress">
                                                <div class="progress-bar" id="memoryProgressBar" role="progressbar" 
                                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">CPU 使用率</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-info" id="cpuProgressBar" role="progressbar" 
                                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">磁盘使用率</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-warning" id="diskProgressBar" role="progressbar" 
                                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="autoRefresh">
                                            <label class="form-check-label" for="autoRefresh">
                                                自动刷新 (30秒)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 服务状态 -->
                        <div class="card shadow">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="bi bi-list-check me-2"></i>服务状态检查
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="status-indicator status-healthy me-2"></div>
                                                    <div>
                                                        <div class="text-xs font-weight-bold text-success text-uppercase">
                                                            配置系统
                                                        </div>
                                                        <div class="small">正常运行</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="status-indicator status-healthy me-2"></div>
                                                    <div>
                                                        <div class="text-xs font-weight-bold text-success text-uppercase">
                                                            字典服务
                                                        </div>
                                                        <div class="small">正常运行</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="status-indicator status-healthy me-2"></div>
                                                    <div>
                                                        <div class="text-xs font-weight-bold text-success text-uppercase">
                                                            日志系统
                                                        </div>
                                                        <div class="small">正常运行</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="status-indicator status-healthy me-2"></div>
                                                    <div>
                                                        <div class="text-xs font-weight-bold text-success text-uppercase">
                                                            缓存系统
                                                        </div>
                                                        <div class="small">正常运行</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 个人设置页面 -->
                    <div id="profilePage" class="page-content d-none">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">个人设置</h1>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-key me-2"></i>修改密码
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="changePasswordForm">
                                            <div class="mb-3">
                                                <label for="oldPassword" class="form-label">当前密码</label>
                                                <input type="password" class="form-control" id="oldPassword" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="newPassword" class="form-label">新密码</label>
                                                <input type="password" class="form-control" id="newPassword" required>
                                                <div class="form-text">密码长度至少6位</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confirmPassword" class="form-label">确认新密码</label>
                                                <input type="password" class="form-control" id="confirmPassword" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-1"></i>更新密码
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-person me-2"></i>账户信息
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td><strong>用户名：</strong></td>
                                                <td id="profileUsername">admin</td>
                                            </tr>
                                            <tr>
                                                <td><strong>登录时间：</strong></td>
                                                <td id="profileLoginTime">--</td>
                                            </tr>
                                            <tr>
                                                <td><strong>会话超时：</strong></td>
                                                <td id="profileSessionTimeout">3600 秒</td>
                                            </tr>
                                            <tr>
                                                <td><strong>权限级别：</strong></td>
                                                <td><span class="badge bg-success">管理员</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 用户偏好设置 -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="bi bi-sliders me-2"></i>用户偏好设置
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- 语音设置 -->
                                            <div class="col-md-6">
                                                <h6 class="text-secondary mb-3">语音设置</h6>
                                                <form id="voiceSettingsForm">
                                                    <div class="mb-3">
                                                        <label for="userDefaultNarrationVoice" class="form-label">默认旁白语音</label>
                                                        <select class="form-select" id="userDefaultNarrationVoice" name="default_narration_voice">
                                                            <option value="">请选择...</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="userDefaultDialogueVoice" class="form-label">默认对话语音</label>
                                                        <select class="form-select" id="userDefaultDialogueVoice" name="default_dialogue_voice">
                                                            <option value="">请选择...</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="userDefaultSpeed" class="form-label">默认语速</label>
                                                        <input type="range" class="form-range" id="userDefaultSpeed" name="default_speed" 
                                                               min="0.5" max="3.0" step="0.1" value="1.0">
                                                        <div class="d-flex justify-content-between">
                                                            <small>0.5x</small>
                                                            <small id="userSpeedValue">1.0x</small>
                                                            <small>3.0x</small>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="userPreferredFormat" class="form-label">首选音频格式</label>
                                                        <select class="form-select" id="userPreferredFormat" name="preferred_format">
                                                            <option value="webm">WebM</option>
                                                            <option value="mp3">MP3</option>
                                                            <option value="wav">WAV</option>
                                                        </select>
                                                    </div>
                                                </form>
                                            </div>

                                            <!-- 界面设置 -->
                                            <div class="col-md-6">
                                                <h6 class="text-secondary mb-3">界面设置</h6>
                                                <form id="userUiSettingsForm">
                                                    <div class="mb-3">
                                                        <label for="userTheme" class="form-label">主题</label>
                                                        <select class="form-select" id="userTheme" name="theme">
                                                            <option value="light">浅色</option>
                                                            <option value="dark">深色</option>
                                                            <option value="auto">跟随系统</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="userLanguage" class="form-label">语言</label>
                                                        <select class="form-select" id="userLanguage" name="language">
                                                            <option value="zh-CN">简体中文</option>
                                                            <option value="en-US">English</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="userAutoPlay" name="auto_play">
                                                            <label class="form-check-label" for="userAutoPlay">
                                                                自动播放音频
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="userShowAdvancedOptions" name="show_advanced_options">
                                                            <label class="form-check-label" for="userShowAdvancedOptions">
                                                                显示高级选项
                                                            </label>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>

                                        <!-- 操作按钮 -->
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <div class="btn-group me-2">
                                                    <button type="button" class="btn btn-primary" onclick="saveUserSettings()">
                                                        <i class="bi bi-check-circle me-1"></i>保存设置
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="loadUserSettings()">
                                                        <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                                    </button>
                                                </div>
                                                <div class="btn-group me-2">
                                                    <button type="button" class="btn btn-outline-info" onclick="exportUserSettings()">
                                                        <i class="bi bi-download me-1"></i>导出
                                                    </button>
                                                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#importUserSettingsModal">
                                                        <i class="bi bi-upload me-1"></i>导入
                                                    </button>
                                                </div>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-outline-success" onclick="backupUserSettings()">
                                                        <i class="bi bi-shield-check me-1"></i>备份
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" onclick="resetUserSettings()">
                                                        <i class="bi bi-arrow-counterclockwise me-1"></i>重置
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div> 
   <!-- 添加规则模态框 -->
    <div class="modal fade" id="addRuleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加字典规则</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRuleForm">
                        <div class="mb-3">
                            <label for="ruleType" class="form-label">规则类型</label>
                            <select class="form-select" id="ruleType" name="type" required>
                                <option value="">请选择类型</option>
                                <option value="pronunciation">发音替换</option>
                                <option value="filter">内容过滤</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="rulePattern" class="form-label">匹配模式</label>
                            <input type="text" class="form-control" id="rulePattern" name="pattern" required>
                            <div class="form-text">支持正则表达式，如：\\bGitHub\\b</div>
                        </div>
                        <div class="mb-3">
                            <label for="ruleReplacement" class="form-label">替换内容</label>
                            <input type="text" class="form-control" id="ruleReplacement" name="replacement" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ruleEnabled" name="enabled" checked>
                                <label class="form-check-label" for="ruleEnabled">
                                    启用此规则
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addRule()">添加规则</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑规则模态框 -->
    <div class="modal fade" id="editRuleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑字典规则</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRuleForm">
                        <input type="hidden" id="editRuleId" name="id">
                        <div class="mb-3">
                            <label for="editRuleType" class="form-label">规则类型</label>
                            <select class="form-select" id="editRuleType" name="type" required>
                                <option value="pronunciation">发音替换</option>
                                <option value="filter">内容过滤</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editRulePattern" class="form-label">匹配模式</label>
                            <input type="text" class="form-control" id="editRulePattern" name="pattern" required>
                        </div>
                        <div class="mb-3">
                            <label for="editRuleReplacement" class="form-label">替换内容</label>
                            <input type="text" class="form-control" id="editRuleReplacement" name="replacement" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editRuleEnabled" name="enabled">
                                <label class="form-check-label" for="editRuleEnabled">
                                    启用此规则
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateRule()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入规则模态框 -->
    <div class="modal fade" id="importRulesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量导入字典规则</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">选择文件</label>
                        <input type="file" class="form-control" id="importFile" accept=".json,.csv">
                        <div class="form-text">支持 JSON 和 CSV 格式文件</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="overwriteRules" name="overwrite">
                            <label class="form-check-label" for="overwriteRules">
                                覆盖已存在的规则
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">或直接粘贴 JSON 数据：</label>
                        <textarea class="form-control" id="importData" rows="10" placeholder='{"rules": [{"type": "pronunciation", "pattern": "\\btest\\b", "replacement": "测试", "enabled": true}]}'></textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>导入格式说明：</h6>
                        <p><strong>JSON 格式：</strong></p>
                        <pre><code>{
  "rules": [
    {
      "type": "pronunciation",
      "pattern": "\\bAPI\\b",
      "replacement": "A P I",
      "enabled": true
    }
  ]
}</code></pre>
                        <p><strong>CSV 格式：</strong>需包含 type, pattern, replacement, enabled 列</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="importRules()">导入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入用户设置模态框 -->
    <div class="modal fade" id="importUserSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">导入用户设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="settingsImportFile" class="form-label">选择设置文件</label>
                        <input type="file" class="form-control" id="settingsImportFile" accept=".json">
                        <div class="form-text">支持 JSON 格式的设置文件</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">或直接粘贴设置数据：</label>
                        <textarea class="form-control" id="settingsImportData" rows="8" placeholder='{"version": "1.0", "settings": {...}}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="importUserSettings()">导入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 备份列表模态框 -->
    <div class="modal fade" id="backupsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设置备份</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="backupsList">
                        <p class="text-center">加载中...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/admin-voice-config.js"></script>
    
    <script>
        // 管理面板语音配置功能
        const adminVoiceData = {
            "zh": ["zh-CN-XiaoxiaoNeural", "zh-CN-YunxiNeural", "zh-CN-YunjianNeural"],
            "en": ["en-US-AvaNeural", "en-US-AndrewNeural", "en-US-EmmaNeural"],
            "ja": ["ja-JP-NanamiNeural", "ja-JP-KeitaNeural"],
            "ko": ["ko-KR-SunHiNeural", "ko-KR-InJoonNeural"]
        };
        
        function updateAdminVoices() {
            console.log('updateAdminVoices 被调用');
            const countrySelect = document.getElementById('adminCountrySelect');
            if (!countrySelect) return;
            
            const selectedCountry = countrySelect.value;
            if (!selectedCountry || !adminVoiceData[selectedCountry]) {
                clearAdminVoiceSelections();
                return;
            }
            
            const singleVoiceMode = document.getElementById('adminSingleVoice')?.checked;
            if (singleVoiceMode) {
                updateAdminSingleVoiceSelect(selectedCountry);
            } else {
                updateAdminMultiVoiceSelects(selectedCountry);
            }
        }
        
        function toggleAdminVoiceMode() {
            console.log('toggleAdminVoiceMode 被调用');
            const singleVoiceMode = document.getElementById('adminSingleVoice')?.checked;
            const singleSection = document.getElementById('adminSingleVoiceSection');
            const multiSection = document.getElementById('adminMultiVoiceSection');
            
            if (!singleSection || !multiSection) return;
            
            if (singleVoiceMode) {
                multiSection.classList.add('d-none');
                singleSection.classList.remove('d-none');
            } else {
                singleSection.classList.add('d-none');
                multiSection.classList.remove('d-none');
            }
            updateAdminVoices();
        }
        
        function clearAdminVoiceSelections() {
            const selects = ['adminUnifiedVoice', 'narrationVoice', 'dialogueVoice'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">请先选择语言</option>';
                }
            });
        }
        
        function updateAdminSingleVoiceSelect(selectedCountry) {
            const voiceSelect = document.getElementById('adminUnifiedVoice');
            if (!voiceSelect) return;
            
            const voices = adminVoiceData[selectedCountry];
            voiceSelect.innerHTML = '<option value="">请选择语音</option>';
            
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice;
                option.textContent = voice;
                voiceSelect.appendChild(option);
            });
        }
        
        function updateAdminMultiVoiceSelects(selectedCountry) {
            const narrationSelect = document.getElementById('narrationVoice');
            const dialogueSelect = document.getElementById('dialogueVoice');
            if (!narrationSelect || !dialogueSelect) return;
            
            const voices = adminVoiceData[selectedCountry];
            
            narrationSelect.innerHTML = '<option value="">请选择旁白语音</option>';
            dialogueSelect.innerHTML = '<option value="">请选择对话语音</option>';
            
            voices.forEach(voice => {
                const narrationOption = document.createElement('option');
                narrationOption.value = voice;
                narrationOption.textContent = voice;
                narrationSelect.appendChild(narrationOption);
                
                const dialogueOption = document.createElement('option');
                dialogueOption.value = voice;
                dialogueOption.textContent = voice;
                dialogueSelect.appendChild(dialogueOption);
            });
        }
        
        async function previewAdminVoice(type) {
            const previewText = document.getElementById('previewText')?.value || '他说"你好世界"然后离开了';
            let voiceId = '';
            
            if (type === 'unified') {
                voiceId = document.getElementById('adminUnifiedVoice')?.value;
            } else if (type === 'narration') {
                voiceId = document.getElementById('narrationVoice')?.value;
            } else if (type === 'dialogue') {
                voiceId = document.getElementById('dialogueVoice')?.value;
            }
            
            if (!voiceId) {
                showAlert('请先选择语音', 'warning');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    text: previewText,
                    narr: voiceId,
                    speed: '1.0'
                });
                
                const previewUrl = `/api?${params.toString()}`;
                const audio = new Audio(previewUrl);
                audio.play().catch(error => {
                    console.error('播放预览失败:', error);
                    showAlert('预览播放失败', 'danger');
                });
                
                const typeText = type === 'unified' ? '统一' : type === 'narration' ? '旁白' : '对话';
                showAlert(`正在预览${typeText}语音`, 'info');
                
            } catch (error) {
                console.error('预览语音失败:', error);
                showAlert('预览语音失败', 'danger');
            }
        }
        
        // 全局变量
        let currentUser = null;
        let autoRefreshInterval = null;
        let currentRules = [];
        
        // 语音数据处理器
        let adminVoiceProcessor = null;
        let adminProcessedVoices = {};


        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            setupEventListeners();
        });

        // 检查认证状态
        function checkAuthStatus() {
            // 这里可以检查是否已登录，暂时直接显示登录页面
            showLoginPage();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 登录表单
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // 导航菜单
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (page) {
                        showPage(page);
                        updateActiveNav(this);
                    }
                });
            });

            // 修改密码表单
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);

            // 搜索和过滤
            document.getElementById('ruleSearch').addEventListener('input', filterRules);
            document.getElementById('ruleTypeFilter').addEventListener('change', filterRules);
            document.getElementById('ruleStatusFilter').addEventListener('change', filterRules);

            // 自动刷新
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(loadSystemStatus, 30000);
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });
        }

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('d-none');
            document.getElementById('mainApp').classList.add('d-none');
        }

        // 显示主应用
        function showMainApp() {
            document.getElementById('loginPage').classList.add('d-none');
            document.getElementById('mainApp').classList.remove('d-none');
            showPage('dashboard');
            loadDashboard();
        }

        // 处理登录
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('currentUser').textContent = currentUser;
                    showMainApp();
                    errorDiv.classList.add('d-none');
                } else {
                    errorDiv.textContent = result.message || '登录失败';
                    errorDiv.classList.remove('d-none');
                }
            } catch (error) {
                errorDiv.textContent = '网络错误，请重试';
                errorDiv.classList.remove('d-none');
            }
        }

        // 登出
        async function logout() {
            try {
                await fetch('/admin/logout', { method: 'POST' });
            } catch (error) {
                console.error('登出请求失败:', error);
            }
            
            currentUser = null;
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            showLoginPage();
        }

        // 显示指定页面
        function showPage(pageName) {
            // 隐藏所有页面
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('d-none');
            });

            // 显示指定页面
            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) {
                targetPage.classList.remove('d-none');
                
                // 根据页面加载相应数据
                switch (pageName) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'config':
                        loadConfig();
                        break;
                    case 'dictionary':
                        loadDictionaryRules();
                        break;
                    case 'profile':
                        loadUserSettings();
                        loadVoicesForSettings();
                        break;
                    case 'logs':
                        loadLogs();
                        break;
                    case 'system':
                        loadSystemStatus();
                        break;
                    case 'profile':
                        loadProfile();
                        break;
                }
            }
        }

        // 更新导航菜单激活状态
        function updateActiveNav(activeLink) {
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            activeLink.classList.add('active');
        }     
   // 加载仪表板数据
        async function loadDashboard() {
            try {
                // 使用统一监控接口获取更完整的数据
                const response = await fetch('/admin/system/monitoring');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    
                    // 更新系统状态卡片
                    const uptimeSeconds = data.performance_metrics.uptime_seconds || 0;
                    const uptimeHuman = formatUptime(uptimeSeconds);
                    document.getElementById('systemUptime').textContent = uptimeHuman;
                    
                    document.getElementById('memoryUsage').textContent = 
                        `${(data.performance_metrics.memory_usage_percent || 0).toFixed(1)}%`;
                    document.getElementById('cpuUsage').textContent = 
                        `${(data.performance_metrics.cpu_usage_percent || 0).toFixed(1)}%`;
                    
                    // 更新 Edge-TTS 状态
                    const edgeTtsElement = document.getElementById('edgeTtsStatus');
                    const edgeTtsStatus = data.performance_metrics.edge_tts_status;
                    const responseTime = data.performance_metrics.edge_tts_response_time;
                    
                    if (edgeTtsStatus) {
                        const timeText = responseTime ? ` (${responseTime.toFixed(0)}ms)` : '';
                        edgeTtsElement.innerHTML = `<span class="status-indicator status-healthy"></span>正常${timeText}`;
                    } else {
                        edgeTtsElement.innerHTML = '<span class="status-indicator status-error"></span>异常';
                    }

                    // 更新配置摘要
                    const configSummary = document.getElementById('configSummary');
                    configSummary.innerHTML = `
                        <p><strong>旁白语音：</strong> ${data.config_summary.tts.narration_voice}</p>
                        <p><strong>对话语音：</strong> ${data.config_summary.tts.dialogue_voice}</p>
                        <p><strong>默认语速：</strong> ${data.config_summary.tts.default_speed}</p>
                        <p><strong>缓存大小限制：</strong> ${formatBytes(data.config_summary.tts.cache_size_limit || 0)}</p>
                    `;

                    // 更新字典统计
                    const dictionaryStats = document.getElementById('dictionaryStats');
                    dictionaryStats.innerHTML = `
                        <p><strong>状态：</strong> ${data.config_summary.dictionary.enabled ? '已启用' : '已禁用'}</p>
                        <p><strong>规则数量：</strong> ${data.config_summary.dictionary.rules_count}</p>
                        <p><strong>规则文件：</strong> ${data.config_summary.dictionary.rules_file}</p>
                    `;
                    
                    // 更新服务统计信息（如果页面上有相应元素）
                    updateServiceStats(data.service_stats);
                    
                    // 更新管理信息
                    updateManagementInfo(data.management_info);
                }
            } catch (error) {
                console.error('加载仪表板数据失败:', error);
                showAlert('加载监控数据失败', 'danger');
            }
        }
        
        // 更新服务统计信息
        function updateServiceStats(stats) {
            // 如果页面上有服务统计元素，更新它们
            const activeRequestsElement = document.getElementById('activeRequests');
            if (activeRequestsElement) {
                activeRequestsElement.textContent = stats.active_requests || 0;
            }
            
            const cacheSizeElement = document.getElementById('cacheSize');
            if (cacheSizeElement) {
                cacheSizeElement.textContent = formatBytes(stats.cache_size || 0);
            }
            
            const cacheHitRateElement = document.getElementById('cacheHitRate');
            if (cacheHitRateElement) {
                cacheHitRateElement.textContent = `${(stats.cache_hit_rate || 0).toFixed(1)}%`;
            }
            
            const errorCount1hElement = document.getElementById('errorCount1h');
            if (errorCount1hElement) {
                errorCount1hElement.textContent = stats.error_count_1h || 0;
            }
        }
        
        // 更新管理信息
        function updateManagementInfo(info) {
            const currentUserElement = document.getElementById('currentUser');
            if (currentUserElement) {
                currentUserElement.textContent = info.current_user || '管理员';
            }
        }
        
        // 格式化运行时间
        function formatUptime(seconds) {
            if (!seconds) return '--';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}天 ${hours}小时`;
            } else if (hours > 0) {
                return `${hours}小时 ${minutes}分钟`;
            } else {
                return `${minutes}分钟`;
            }
        }

        // 刷新仪表板
        function refreshDashboard() {
            loadDashboard();
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/admin/config');
                const result = await response.json();

                if (result.success) {
                    const config = result.data;
                    
                    // TTS 配置
                    if (config.tts) {
                        document.getElementById('narrationVoice').value = config.tts.narration_voice || '';
                        document.getElementById('dialogueVoice').value = config.tts.dialogue_voice || '';
                        document.getElementById('defaultSpeed').value = config.tts.default_speed || 1.2;
                        document.getElementById('cacheSizeLimit').value = config.tts.cache_size_limit || 10485760;
                        document.getElementById('cacheTimeLimit').value = config.tts.cache_time_limit || 1200;
                    }

                    // 系统配置
                    if (config.system) {
                        document.getElementById('systemHost').value = config.system.host || '0.0.0.0';
                        document.getElementById('systemPort').value = config.system.port || 5000;
                        document.getElementById('systemDebug').checked = config.system.debug || false;
                        document.getElementById('maxWorkers').value = config.system.max_workers || 5;
                    }

                    // 日志配置
                    if (config.logging) {
                        document.getElementById('logLevel').value = config.logging.level || 'INFO';
                        document.getElementById('logFile').value = config.logging.file || 'logs/app.log';
                        document.getElementById('logMaxSize').value = config.logging.max_size || '10MB';
                        document.getElementById('logBackupCount').value = config.logging.backup_count || 5;
                    }

                    // 字典配置
                    if (config.dictionary) {
                        document.getElementById('dictionaryEnabled').checked = config.dictionary.enabled || false;
                        document.getElementById('rulesFile').value = config.dictionary.rules_file || 'dictionary/rules.json';
                    }
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                showAlert('加载配置失败', 'danger');
            }
        }

        // 保存配置
        async function saveConfig() {
            try {
                const configData = {
                    tts: {
                        narration_voice: document.getElementById('narrationVoice').value,
                        dialogue_voice: document.getElementById('dialogueVoice').value,
                        default_speed: parseFloat(document.getElementById('defaultSpeed').value),
                        cache_size_limit: parseInt(document.getElementById('cacheSizeLimit').value),
                        cache_time_limit: parseInt(document.getElementById('cacheTimeLimit').value)
                    },
                    system: {
                        host: document.getElementById('systemHost').value,
                        port: parseInt(document.getElementById('systemPort').value),
                        debug: document.getElementById('systemDebug').checked,
                        max_workers: parseInt(document.getElementById('maxWorkers').value)
                    },
                    logging: {
                        level: document.getElementById('logLevel').value,
                        file: document.getElementById('logFile').value,
                        max_size: document.getElementById('logMaxSize').value,
                        backup_count: parseInt(document.getElementById('logBackupCount').value)
                    },
                    dictionary: {
                        enabled: document.getElementById('dictionaryEnabled').checked,
                        rules_file: document.getElementById('rulesFile').value
                    }
                };

                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('配置保存成功', 'success');
                } else {
                    showAlert(result.message || '配置保存失败', 'danger');
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                showAlert('保存配置失败', 'danger');
            }
        }

        // 语音预览
        async function previewVoice(type) {
            const text = document.getElementById('previewText').value;
            if (!text.trim()) {
                showAlert('请输入预览文本', 'warning');
                return;
            }

            const voice = type === 'narration' ? 
                document.getElementById('narrationVoice').value : 
                document.getElementById('dialogueVoice').value;
            const speed = document.getElementById('defaultSpeed').value;

            try {
                const params = new URLSearchParams({
                    text: text,
                    speed: speed,
                    [type === 'narration' ? 'narr' : 'dlg']: voice
                });

                const audioUrl = `/api?${params.toString()}`;
                const audioElement = document.getElementById('previewAudio');
                audioElement.src = audioUrl;
                audioElement.classList.remove('d-none');
                audioElement.play();
            } catch (error) {
                console.error('语音预览失败:', error);
                showAlert('语音预览失败', 'danger');
            }
        }

        // 加载字典规则
        async function loadDictionaryRules() {
            try {
                const response = await fetch('/admin/dictionary');
                const result = await response.json();

                if (result.success) {
                    currentRules = result.data;
                    displayRules(currentRules);
                }
            } catch (error) {
                console.error('加载字典规则失败:', error);
                showAlert('加载字典规则失败', 'danger');
            }
        }

        // 显示规则列表
        function displayRules(rules) {
            const tbody = document.getElementById('rulesTableBody');
            
            if (rules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无规则</td></tr>';
                return;
            }

            tbody.innerHTML = rules.map(rule => `
                <tr>
                    <td>${rule.id}</td>
                    <td>
                        <span class="badge ${rule.type === 'pronunciation' ? 'bg-primary' : 'bg-info'}">
                            ${rule.type === 'pronunciation' ? '发音替换' : '内容过滤'}
                        </span>
                    </td>
                    <td><code>${rule.pattern}</code></td>
                    <td>${rule.replacement}</td>
                    <td>
                        <span class="badge ${rule.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${rule.enabled ? '已启用' : '已禁用'}
                        </span>
                    </td>
                    <td>${new Date(rule.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRule('${rule.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('${rule.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleRule('${rule.id}', ${!rule.enabled})">
                            <i class="bi bi-${rule.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 过滤规则
        function filterRules() {
            const searchTerm = document.getElementById('ruleSearch').value.toLowerCase();
            const typeFilter = document.getElementById('ruleTypeFilter').value;
            const statusFilter = document.getElementById('ruleStatusFilter').value;

            let filteredRules = currentRules.filter(rule => {
                const matchesSearch = !searchTerm || 
                    rule.pattern.toLowerCase().includes(searchTerm) ||
                    rule.replacement.toLowerCase().includes(searchTerm) ||
                    rule.id.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || rule.type === typeFilter;
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'enabled' && rule.enabled) ||
                    (statusFilter === 'disabled' && !rule.enabled);

                return matchesSearch && matchesType && matchesStatus;
            });

            displayRules(filteredRules);
        }      
  // 添加规则
        async function addRule() {
            const form = document.getElementById('addRuleForm');
            const formData = new FormData(form);
            
            const ruleData = {
                type: formData.get('type'),
                pattern: formData.get('pattern'),
                replacement: formData.get('replacement'),
                enabled: document.getElementById('ruleEnabled').checked
            };

            try {
                const response = await fetch('/admin/dictionary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ruleData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('规则添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
                    form.reset();
                    loadDictionaryRules();
                } else {
                    showAlert(result.message || '规则添加失败', 'danger');
                }
            } catch (error) {
                console.error('添加规则失败:', error);
                showAlert('添加规则失败', 'danger');
            }
        }

        // 编辑规则
        function editRule(ruleId) {
            const rule = currentRules.find(r => r.id === ruleId);
            if (!rule) return;

            document.getElementById('editRuleId').value = rule.id;
            document.getElementById('editRuleType').value = rule.type;
            document.getElementById('editRulePattern').value = rule.pattern;
            document.getElementById('editRuleReplacement').value = rule.replacement;
            document.getElementById('editRuleEnabled').checked = rule.enabled;

            new bootstrap.Modal(document.getElementById('editRuleModal')).show();
        }

        // 更新规则
        async function updateRule() {
            const ruleId = document.getElementById('editRuleId').value;
            const form = document.getElementById('editRuleForm');
            const formData = new FormData(form);
            
            const ruleData = {
                type: formData.get('type'),
                pattern: formData.get('pattern'),
                replacement: formData.get('replacement'),
                enabled: document.getElementById('editRuleEnabled').checked
            };

            try {
                const response = await fetch(`/admin/dictionary/${ruleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ruleData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('规则更新成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editRuleModal')).hide();
                    loadDictionaryRules();
                } else {
                    showAlert(result.message || '规则更新失败', 'danger');
                }
            } catch (error) {
                console.error('更新规则失败:', error);
                showAlert('更新规则失败', 'danger');
            }
        }

        // 删除规则
        async function deleteRule(ruleId) {
            if (!confirm('确定要删除这个规则吗？')) return;

            try {
                const response = await fetch(`/admin/dictionary/${ruleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('规则删除成功', 'success');
                    loadDictionaryRules();
                } else {
                    showAlert(result.message || '规则删除失败', 'danger');
                }
            } catch (error) {
                console.error('删除规则失败:', error);
                showAlert('删除规则失败', 'danger');
            }
        }

        // 切换规则状态
        async function toggleRule(ruleId, enabled) {
            try {
                const response = await fetch(`/admin/dictionary/${ruleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled: enabled })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`规则已${enabled ? '启用' : '禁用'}`, 'success');
                    loadDictionaryRules();
                } else {
                    showAlert(result.message || '操作失败', 'danger');
                }
            } catch (error) {
                console.error('切换规则状态失败:', error);
                showAlert('操作失败', 'danger');
            }
        }

        // 导入规则
        async function importRules() {
            try {
                const fileInput = document.getElementById('importFile');
                const textInput = document.getElementById('importData');
                const overwrite = document.getElementById('overwriteRules').checked;
                
                let rulesData = null;
                
                // 优先使用文件输入
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileContent = await readFileContent(file);
                    
                    if (file.name.endsWith('.csv')) {
                        rulesData = parseCSVRules(fileContent);
                    } else {
                        const jsonData = JSON.parse(fileContent);
                        rulesData = jsonData.rules || jsonData;
                    }
                } else if (textInput.value.trim()) {
                    // 使用文本输入
                    const jsonData = JSON.parse(textInput.value);
                    rulesData = jsonData.rules || jsonData;
                } else {
                    showAlert('请选择文件或输入规则数据', 'warning');
                    return;
                }
                
                if (!Array.isArray(rulesData)) {
                    showAlert('规则数据格式错误，必须是数组', 'danger');
                    return;
                }
                
                // 发送导入请求
                const response = await fetch('/admin/dictionary/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rules: rulesData,
                        overwrite: overwrite
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('importRulesModal')).hide();
                    
                    // 清空表单
                    fileInput.value = '';
                    textInput.value = '';
                    document.getElementById('overwriteRules').checked = false;
                    
                    loadDictionaryRules();
                } else {
                    showAlert(result.message || '导入失败', 'danger');
                }
                
            } catch (error) {
                console.error('导入规则失败:', error);
                showAlert('导入规则失败: ' + error.message, 'danger');
            }
        }
        
        // 导出规则
        async function exportDictionaryRules() {
            try {
                const response = await fetch('/admin/dictionary/export?format=json');
                const result = await response.json();
                
                if (result.success) {
                    // 下载 JSON 文件
                    const dataStr = JSON.stringify(result.data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `dictionary_rules_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
                    link.click();
                    
                    showAlert('规则导出成功', 'success');
                } else {
                    showAlert('导出失败', 'danger');
                }
            } catch (error) {
                console.error('导出规则失败:', error);
                showAlert('导出规则失败', 'danger');
            }
        }
        
        // 读取文件内容
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // 解析 CSV 规则
        function parseCSVRules(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const rules = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                const rule = {};
                
                headers.forEach((header, index) => {
                    if (values[index] !== undefined) {
                        if (header === 'enabled') {
                            rule[header] = values[index].toLowerCase() === 'true';
                        } else {
                            rule[header] = values[index];
                        }
                    }
                });
                
                if (rule.type && rule.pattern && rule.replacement) {
                    rules.push(rule);
                }
            }
            
            return rules;
        }

        // 用户设置相关函数
        async function loadUserSettings() {
            try {
                const response = await fetch('/api/settings');
                const result = await response.json();
                
                if (result.success) {
                    const settings = result.data.settings;
                    
                    // 填充表单
                    document.getElementById('userDefaultNarrationVoice').value = settings.default_narration_voice || '';
                    document.getElementById('userDefaultDialogueVoice').value = settings.default_dialogue_voice || '';
                    document.getElementById('userDefaultSpeed').value = settings.default_speed || 1.0;
                    document.getElementById('userPreferredFormat').value = settings.preferred_format || 'webm';
                    document.getElementById('userTheme').value = settings.theme || 'light';
                    document.getElementById('userLanguage').value = settings.language || 'zh-CN';
                    document.getElementById('userAutoPlay').checked = settings.auto_play || false;
                    document.getElementById('userShowAdvancedOptions').checked = settings.show_advanced_options || false;
                    
                    // 更新语速显示
                    document.getElementById('userSpeedValue').textContent = (settings.default_speed || 1.0) + 'x';
                    
                    console.log('用户设置加载成功');
                } else {
                    showAlert('加载用户设置失败', 'danger');
                }
            } catch (error) {
                console.error('加载用户设置失败:', error);
                showAlert('加载用户设置失败', 'danger');
            }
        }
        
        async function saveUserSettings() {
            try {
                const settingsData = {
                    default_narration_voice: document.getElementById('userDefaultNarrationVoice').value || null,
                    default_dialogue_voice: document.getElementById('userDefaultDialogueVoice').value || null,
                    default_speed: parseFloat(document.getElementById('userDefaultSpeed').value),
                    preferred_format: document.getElementById('userPreferredFormat').value,
                    theme: document.getElementById('userTheme').value,
                    language: document.getElementById('userLanguage').value,
                    auto_play: document.getElementById('userAutoPlay').checked,
                    show_advanced_options: document.getElementById('userShowAdvancedOptions').checked
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('设置保存成功', 'success');
                } else {
                    showAlert(result.message || '设置保存失败', 'danger');
                }
            } catch (error) {
                console.error('保存用户设置失败:', error);
                showAlert('保存用户设置失败', 'danger');
            }
        }
        
        async function exportUserSettings() {
            try {
                const response = await fetch('/api/settings/export?download=true');
                
                if (response.ok) {
                    // 触发文件下载
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `user_settings_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('设置导出成功', 'success');
                } else {
                    showAlert('设置导出失败', 'danger');
                }
            } catch (error) {
                console.error('导出用户设置失败:', error);
                showAlert('导出用户设置失败', 'danger');
            }
        }
        
        async function importUserSettings() {
            try {
                const fileInput = document.getElementById('settingsImportFile');
                const textInput = document.getElementById('settingsImportData');
                
                let settingsData = null;
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileContent = await readFileContent(file);
                    settingsData = JSON.parse(fileContent);
                } else if (textInput.value.trim()) {
                    settingsData = JSON.parse(textInput.value);
                } else {
                    showAlert('请选择文件或输入设置数据', 'warning');
                    return;
                }
                
                const response = await fetch('/api/settings/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsData)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('设置导入成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('importUserSettingsModal')).hide();
                    
                    // 清空表单
                    fileInput.value = '';
                    textInput.value = '';
                    
                    // 重新加载设置
                    loadUserSettings();
                } else {
                    showAlert(result.message || '设置导入失败', 'danger');
                }
            } catch (error) {
                console.error('导入用户设置失败:', error);
                showAlert('导入用户设置失败: ' + error.message, 'danger');
            }
        }
        
        async function resetUserSettings() {
            if (!confirm('确定要重置所有设置为默认值吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/settings/reset', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('设置已重置为默认值', 'success');
                    loadUserSettings();
                } else {
                    showAlert(result.message || '设置重置失败', 'danger');
                }
            } catch (error) {
                console.error('重置用户设置失败:', error);
                showAlert('重置用户设置失败', 'danger');
            }
        }
        
        async function backupUserSettings() {
            try {
                const response = await fetch('/api/settings/backup', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('设置备份成功', 'success');
                } else {
                    showAlert(result.message || '设置备份失败', 'danger');
                }
            } catch (error) {
                console.error('备份用户设置失败:', error);
                showAlert('备份用户设置失败', 'danger');
            }
        }
        
        async function loadVoicesForSettings() {
            try {
                const response = await fetch('/api/voices');
                const result = await response.json();
                
                if (result.success) {
                    const voices = result.data;
                    
                    // 填充旁白语音选项
                    const narrationSelect = document.getElementById('userDefaultNarrationVoice');
                    const dialogueSelect = document.getElementById('userDefaultDialogueVoice');
                    
                    // 清空现有选项
                    narrationSelect.innerHTML = '<option value="">请选择...</option>';
                    dialogueSelect.innerHTML = '<option value="">请选择...</option>';
                    
                    // 添加语音选项
                    voices.forEach(voice => {
                        const option1 = new Option(voice.FriendlyName, voice.ShortName);
                        const option2 = new Option(voice.FriendlyName, voice.ShortName);
                        narrationSelect.add(option1);
                        dialogueSelect.add(option2);
                    });
                }
            } catch (error) {
                console.error('加载语音列表失败:', error);
            }
        }
        
        // 语速滑块事件
        document.addEventListener('DOMContentLoaded', function() {
            const speedSlider = document.getElementById('userDefaultSpeed');
            const speedValue = document.getElementById('userSpeedValue');
            
            if (speedSlider && speedValue) {
                speedSlider.addEventListener('input', function() {
                    speedValue.textContent = this.value + 'x';
                });
            }
        });

        // 加载日志
        async function loadLogs() {
            const level = document.getElementById('logLevelFilter').value;
            const type = document.getElementById('logTypeFilter').value;
            const lines = document.getElementById('logLines').value;
            const search = document.getElementById('logSearch').value;
            const startTime = document.getElementById('logStartTime').value;
            const endTime = document.getElementById('logEndTime').value;

            try {
                const params = new URLSearchParams();
                
                if (level && level !== 'ALL') params.append('level', level);
                if (type && type !== 'ALL') params.append('type', type);
                if (lines) params.append('lines', lines);
                if (search) params.append('search', search);
                if (startTime) params.append('start_time', new Date(startTime).toISOString());
                if (endTime) params.append('end_time', new Date(endTime).toISOString());

                const response = await fetch(`/admin/logs?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    displayLogs(result.data.logs);
                    updateLogStats(result.data.stats, result.data.type_stats, result.data.level_stats);
                    document.getElementById('logTimestamp').textContent = 
                        `最后更新：${new Date().toLocaleString()}`;
                }
            } catch (error) {
                console.error('加载日志失败:', error);
                showAlert('加载日志失败', 'danger');
            }
        }

        // 显示日志
        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">暂无符合条件的日志</div>';
                return;
            }

            container.innerHTML = logs.map(log => {
                return formatLogEntry(log);
            }).join('');

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }
        
        // 格式化单条日志条目
        function formatLogEntry(log) {
            const levelClass = log.level_color || 'text-info';
            const icon = log.icon || 'ℹ️';
            const typeClass = getTypeClass(log.type);
            
            let content = `
                <div class="log-entry ${levelClass} border-start border-3 ${typeClass} mb-2 p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="me-2">${icon}</span>
                                <span class="badge bg-secondary me-2">${log.level}</span>
                                <span class="badge bg-info me-2">${log.type}</span>
                                <small class="text-muted">[${log.timestamp}]</small>
                                <small class="text-muted ms-2">[${log.module}]</small>
                            </div>
                            <div class="log-message">
                                ${escapeHtml(log.message)}
                            </div>
            `;
            
            // HTTP 请求信息
            if (log.http_method && log.http_path) {
                content += `
                    <div class="mt-1">
                        <span class="badge bg-primary me-1">${log.http_method}</span>
                        <code class="text-primary">${log.http_path}</code>
                `;
                
                if (log.status_code) {
                    const statusClass = log.status_color || 'text-info';
                    content += `<span class="badge ${statusClass} ms-2">${log.status_code}</span>`;
                }
                
                if (log.duration_ms) {
                    const perfClass = getPerfClass(log.duration_ms);
                    content += `<span class="badge ${perfClass} ms-1">${log.duration_ms}ms</span>`;
                }
                
                content += `</div>`;
            }
            
            // 错误信息
            if (log.error_type) {
                content += `
                    <div class="mt-1 text-danger">
                        <strong>错误类型:</strong> ${log.error_type}
                        ${log.error_message ? `<br><strong>错误信息:</strong> ${escapeHtml(log.error_message)}` : ''}
                    </div>
                `;
            }
            
            // 审计信息
            if (log.audit_action) {
                content += `
                    <div class="mt-1">
                        <strong>操作:</strong> ${log.audit_action}
                        ${log.audit_user ? `<strong class="ms-2">用户:</strong> ${log.audit_user}` : ''}
                    </div>
                `;
            }
            
            content += `
                        </div>
                        <div class="ms-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleLogDetails(this)" title="查看详情">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="log-details d-none mt-2">
                        <pre class="bg-light p-2 rounded"><code>${JSON.stringify(log.raw_data, null, 2)}</code></pre>
                    </div>
                </div>
            `;
            
            return content;
        }
        
        // 获取类型对应的样式类
        function getTypeClass(type) {
            const typeClasses = {
                'audio': 'border-success',
                'http': 'border-info',
                'api': 'border-primary',
                'error': 'border-danger',
                'audit': 'border-warning',
                'performance': 'border-secondary'
            };
            return typeClasses[type] || 'border-light';
        }
        
        // 获取性能级别对应的样式类
        function getPerfClass(duration) {
            if (duration < 100) return 'bg-success';
            if (duration < 500) return 'bg-info';
            if (duration < 1000) return 'bg-warning';
            return 'bg-danger';
        }
        
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 切换日志详情显示
        function toggleLogDetails(button) {
            const details = button.closest('.log-entry').querySelector('.log-details');
            const icon = button.querySelector('i');
            
            if (details.classList.contains('d-none')) {
                details.classList.remove('d-none');
                icon.className = 'bi bi-chevron-up';
            } else {
                details.classList.add('d-none');
                icon.className = 'bi bi-chevron-down';
            }
        }
        
        // 更新日志统计信息
        function updateLogStats(stats, typeStats, levelStats) {
            document.getElementById('logStatsTotal').textContent = stats.total_lines || 0;
            document.getElementById('logStatsFiltered').textContent = stats.filtered_entries || 0;
            document.getElementById('logStatsDisplayed').textContent = stats.returned_entries || 0;
            
            // 类型分布
            const typeText = Object.entries(typeStats || {})
                .map(([type, count]) => `${type}:${count}`)
                .join(', ') || '无';
            document.getElementById('logStatsTypes').textContent = typeText;
            
            // 级别分布
            const levelText = Object.entries(levelStats || {})
                .map(([level, count]) => `${level}:${count}`)
                .join(', ') || '无';
            document.getElementById('logStatsLevels').textContent = levelText;
        }

        // 清空时间范围过滤器
        function clearTimeFilters() {
            document.getElementById('logStartTime').value = '';
            document.getElementById('logEndTime').value = '';
            loadLogs();
        }
        
        // 设置快速时间范围
        function setQuickTimeRange(hours) {
            const now = new Date();
            const start = new Date(now.getTime() - hours * 60 * 60 * 1000);
            
            document.getElementById('logStartTime').value = start.toISOString().slice(0, 16);
            document.getElementById('logEndTime').value = now.toISOString().slice(0, 16);
            loadLogs();
        }

        // 清空日志显示
        function clearLogDisplay() {
            document.getElementById('logContainer').innerHTML = 
                '<div class="text-center text-muted p-3">日志已清空，点击刷新重新加载</div>';
        }

        // 加载系统状态
        async function loadSystemStatus() {
            try {
                // 使用统一监控接口获取完整的系统状态
                const response = await fetch('/admin/system/monitoring');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    const systemInfo = data.system_info;
                    const performanceMetrics = data.performance_metrics;
                    const serviceStats = data.service_stats;
                    const managementInfo = data.management_info;
                    
                    // 更新详细信息
                    const uptimeHuman = formatUptime(performanceMetrics.uptime_seconds || 0);
                    document.getElementById('detailUptime').textContent = uptimeHuman;
                    
                    document.getElementById('detailMemory').textContent = 
                        `${performanceMetrics.memory_usage_percent.toFixed(1)}% (${formatBytes(systemInfo.memory_used || 0)}/${formatBytes(systemInfo.memory_total || 0)})`;
                    
                    document.getElementById('detailCpu').textContent = 
                        `${performanceMetrics.cpu_usage_percent.toFixed(1)}%`;
                    
                    document.getElementById('detailDisk').textContent = 
                        `${performanceMetrics.disk_usage_percent.toFixed(1)}%`;
                    
                    // Edge-TTS 状态显示响应时间
                    const edgeTtsStatus = performanceMetrics.edge_tts_status;
                    const responseTime = performanceMetrics.edge_tts_response_time;
                    const edgeTtsText = edgeTtsStatus ? 
                        `<span class="status-indicator status-healthy"></span>正常${responseTime ? ` (${responseTime.toFixed(0)}ms)` : ''}` :
                        '<span class="status-indicator status-error"></span>异常';
                    document.getElementById('detailEdgeTts').innerHTML = edgeTtsText;
                    
                    // 活跃请求数
                    document.getElementById('detailSessions').textContent = serviceStats.active_requests || '0';
                    
                    // 配置更新时间
                    const configTime = managementInfo.last_config_update;
                    document.getElementById('detailConfigTime').textContent = 
                        configTime ? new Date(configTime).toLocaleString() : '--';

                    // 更新进度条
                    updateProgressBar('memoryProgressBar', performanceMetrics.memory_usage_percent);
                    updateProgressBar('cpuProgressBar', performanceMetrics.cpu_usage_percent);
                    updateProgressBar('diskProgressBar', performanceMetrics.disk_usage_percent);
                    
                    // 更新额外的监控信息
                    updateExtendedMonitoringInfo(data);
                }
            } catch (error) {
                console.error('加载系统状态失败:', error);
                showAlert('加载系统状态失败', 'danger');
            }
        }
        
        // 更新扩展监控信息
        function updateExtendedMonitoringInfo(data) {
            const serviceStats = data.service_stats;
            const systemInfo = data.system_info;
            
            // 更新缓存信息
            const cacheInfoElement = document.getElementById('cacheInfo');
            if (cacheInfoElement) {
                cacheInfoElement.innerHTML = `
                    <p><strong>缓存大小：</strong> ${formatBytes(serviceStats.cache_size || 0)}</p>
                    <p><strong>缓存命中率：</strong> ${(serviceStats.cache_hit_rate || 0).toFixed(1)}%</p>
                `;
            }
            
            // 更新错误统计
            const errorStatsElement = document.getElementById('errorStats');
            if (errorStatsElement) {
                errorStatsElement.innerHTML = `
                    <p><strong>1小时内错误：</strong> ${serviceStats.error_count_1h || 0}</p>
                    <p><strong>24小时内错误：</strong> ${serviceStats.error_count_24h || 0}</p>
                `;
            }
            
            // 更新系统状态指示器
            const statusIndicator = document.getElementById('systemStatusIndicator');
            if (statusIndicator) {
                const status = systemInfo.status || 'unknown';
                let statusClass = 'status-healthy';
                let statusText = '健康';
                
                switch (status) {
                    case 'healthy':
                        statusClass = 'status-healthy';
                        statusText = '健康';
                        break;
                    case 'degraded':
                        statusClass = 'status-warning';
                        statusText = '降级';
                        break;
                    case 'unhealthy':
                        statusClass = 'status-error';
                        statusText = '异常';
                        break;
                    default:
                        statusClass = 'status-warning';
                        statusText = '未知';
                }
                
                statusIndicator.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;
            }
        }

        // 更新进度条
        function updateProgressBar(id, percentage) {
            const progressBar = document.getElementById(id);
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = `${percentage.toFixed(1)}%`;

            // 根据使用率设置颜色
            progressBar.className = 'progress-bar';
            if (percentage > 80) {
                progressBar.classList.add('bg-danger');
            } else if (percentage > 60) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-success');
            }
        }

        // 重启系统
        async function restartSystem() {
            if (!confirm('确定要重启系统吗？这将中断当前所有连接。')) return;

            try {
                const response = await fetch('/admin/system/restart', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('重启请求已提交', 'info');
                } else {
                    showAlert(result.message || '重启失败', 'danger');
                }
            } catch (error) {
                console.error('重启系统失败:', error);
                showAlert('重启系统失败', 'danger');
            }
        }

        // 加载个人资料
        function loadProfile() {
            document.getElementById('profileUsername').textContent = currentUser || 'admin';
            document.getElementById('profileLoginTime').textContent = new Date().toLocaleString();
        }

        // 处理修改密码
        async function handleChangePassword(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert('新密码和确认密码不匹配', 'danger');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('密码长度至少6位', 'danger');
                return;
            }

            try {
                const response = await fetch('/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('密码修改成功', 'success');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showAlert(result.message || '密码修改失败', 'danger');
                }
            } catch (error) {
                console.error('修改密码失败:', error);
                showAlert('修改密码失败', 'danger');
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            // 创建提示框
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 移动端功能
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        // 初始化移动端优化
        function initializeMobileAdmin() {
            if (!window.mobileDetector) return;
            
            const deviceInfo = mobileDetector.getDeviceInfo();
            console.log('管理面板设备信息:', deviceInfo);
            
            // 移动端优化
            if (deviceInfo.isMobile) {
                setupMobileAdminOptimizations();
            }
            
            // 触摸设备优化
            if (deviceInfo.touchSupport) {
                setupTouchAdminOptimizations();
            }
            
            // 监听设备变化
            document.addEventListener('deviceresize', handleAdminDeviceChange);
            document.addEventListener('orientationchange', handleAdminOrientationChange);
        }
        
        function setupMobileAdminOptimizations() {
            // 优化表格显示
            const tables = document.querySelectorAll('.table');
            tables.forEach(table => {
                if (!table.closest('.table-responsive')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-responsive';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
            
            // 优化按钮组
            const btnToolbars = document.querySelectorAll('.btn-toolbar');
            btnToolbars.forEach(toolbar => {
                toolbar.classList.add('mobile-btn-toolbar');
            });
            
            // 自动关闭侧边栏（点击主内容区域时）
            document.querySelector('.main-content')?.addEventListener('click', () => {
                closeMobileSidebar();
            });
            
            // 侧边栏链接点击后自动关闭
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    setTimeout(closeMobileSidebar, 100);
                });
            });
        }
        
        function setupTouchAdminOptimizations() {
            // 添加触摸反馈
            document.addEventListener('touchstart', function(e) {
                if (e.target.matches('.btn, .nav-link, .dropdown-item')) {
                    e.target.classList.add('touch-active');
                }
            });
            
            document.addEventListener('touchend', function(e) {
                setTimeout(() => {
                    document.querySelectorAll('.touch-active').forEach(el => {
                        el.classList.remove('touch-active');
                    });
                }, 150);
            });
            
            // 优化下拉菜单
            const dropdowns = document.querySelectorAll('.dropdown-toggle');
            dropdowns.forEach(dropdown => {
                dropdown.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });
        }
        
        function handleAdminDeviceChange(event) {
            const deviceInfo = event.detail;
            console.log('管理面板设备变化:', deviceInfo);
            
            // 设备类型变化时重新应用优化
            if (deviceInfo.isMobile) {
                document.body.classList.add('mobile-admin');
                setupMobileAdminOptimizations();
            } else {
                document.body.classList.remove('mobile-admin');
                closeMobileSidebar();
            }
        }
        
        function handleAdminOrientationChange(event) {
            const orientation = event.detail.orientation;
            console.log('管理面板方向变化:', orientation);
            
            // 方向变化时关闭侧边栏
            closeMobileSidebar();
            
            // 重新布局表格
            setTimeout(() => {
                const tables = document.querySelectorAll('.table');
                tables.forEach(table => {
                    // 触发表格重绘
                    table.style.display = 'none';
                    table.offsetHeight; // 强制重排
                    table.style.display = '';
                });
            }, 100);
        }

        // 在页面加载时初始化移动端功能
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟初始化以确保 mobileDetector 已加载
            setTimeout(initializeMobileAdmin, 100);
        });
    </script>
</body>
</html>