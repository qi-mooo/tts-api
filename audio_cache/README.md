# ä¼˜åŒ–éŸ³é¢‘ç¼“å­˜ç³»ç»Ÿ

## æ¦‚è¿°

ä¼˜åŒ–éŸ³é¢‘ç¼“å­˜ç³»ç»Ÿæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€åŠŸèƒ½ä¸°å¯Œçš„éŸ³é¢‘ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼Œä¸“ä¸ºæ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰åº”ç”¨è®¾è®¡ã€‚è¯¥ç³»ç»Ÿæä¾›äº†æ™ºèƒ½çš„å†…å­˜ç®¡ç†ã€è¯¦ç»†çš„ç»Ÿè®¡ç›‘æ§å’Œçµæ´»çš„é…ç½®é€‰é¡¹ã€‚

## ä¸»è¦ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- **LRUç¼“å­˜ç­–ç•¥**: æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œæ™ºèƒ½ç®¡ç†ç¼“å­˜æ¡ç›®
- **é…ç½®é›†æˆ**: ä¸é…ç½®ç®¡ç†ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°
- **çº¿ç¨‹å®‰å…¨**: å®Œå…¨çº¿ç¨‹å®‰å…¨çš„å®ç°ï¼Œæ”¯æŒå¹¶å‘è®¿é—®
- **å†…å­˜ä¼˜åŒ–**: æ™ºèƒ½å†…å­˜ç®¡ç†å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶

### ğŸ“Š ç»Ÿè®¡ç›‘æ§
- **å‘½ä¸­ç‡ç»Ÿè®¡**: å®æ—¶è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
- **å†…å­˜ä½¿ç”¨ç›‘æ§**: è¯¦ç»†çš„å†…å­˜ä½¿ç”¨æƒ…å†µè·Ÿè¸ª
- **æ€§èƒ½æŒ‡æ ‡**: åŒ…æ‹¬å¹³å‡æ¡ç›®å¤§å°ã€æœ€æ—§æ¡ç›®å¹´é¾„ç­‰
- **æ¡ç›®è¯¦æƒ…**: æ¯ä¸ªç¼“å­˜æ¡ç›®çš„è¯¦ç»†ä¿¡æ¯

### âš™ï¸ é«˜çº§åŠŸèƒ½
- **è‡ªåŠ¨è¿‡æœŸ**: åŸºäºæ—¶é—´çš„è‡ªåŠ¨æ¡ç›®è¿‡æœŸ
- **ç¼“å­˜ä¼˜åŒ–**: ä¸»åŠ¨çš„ç¼“å­˜ä¼˜åŒ–å’Œæ¸…ç†
- **é…ç½®çƒ­æ›´æ–°**: è¿è¡Œæ—¶é…ç½®æ›´æ–°æ”¯æŒ
- **è¯¦ç»†æ—¥å¿—**: ç»“æ„åŒ–æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œ

## å®‰è£…å’Œä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨

```python
from audio_cache import OptimizedAudioCache

# åˆ›å»ºç¼“å­˜å®ä¾‹
cache = OptimizedAudioCache(
    size_limit=10*1024*1024,  # 10MB
    time_limit=1200           # 20åˆ†é’Ÿ
)

# å­˜å‚¨éŸ³é¢‘
cache.put("ä½ å¥½ä¸–ç•Œ", "zh-CN-YunjianNeural", 1.0, audio_segment)

# è·å–éŸ³é¢‘
audio = cache.get("ä½ å¥½ä¸–ç•Œ", "zh-CN-YunjianNeural", 1.0)
if audio:
    print("ç¼“å­˜å‘½ä¸­ï¼")
else:
    print("ç¼“å­˜æœªå‘½ä¸­")
```

### ç»Ÿè®¡ä¿¡æ¯è·å–

```python
# è·å–è¯¦ç»†ç»Ÿè®¡
stats = cache.get_stats()
print(f"å‘½ä¸­ç‡: {stats['hit_rate']:.2%}")
print(f"å†…å­˜ä½¿ç”¨: {stats['memory_usage_percent']:.1f}%")
print(f"ç¼“å­˜æ¡ç›®æ•°: {stats['entry_count']}")

# è·å–æ¡ç›®è¯¦æƒ…
entries = cache.get_cache_entries_info()
for entry in entries:
    print(f"æ¡ç›®å¤§å°: {entry['size_kb']}KB, è®¿é—®æ¬¡æ•°: {entry['access_count']}")
```

### ç¼“å­˜ç®¡ç†

```python
# æ¸…ç©ºç¼“å­˜
cache.clear()

# ä¼˜åŒ–ç¼“å­˜
result = cache.optimize()
print(f"ä¼˜åŒ–ç§»é™¤äº† {result['entries_removed']} ä¸ªæ¡ç›®")

# æ£€æŸ¥ç¼“å­˜çŠ¶æ€
print(f"ç¼“å­˜æ¡ç›®æ•°: {len(cache)}")
```

## API å‚è€ƒ

### OptimizedAudioCache ç±»

#### æ„é€ å‡½æ•°
```python
OptimizedAudioCache(size_limit=None, time_limit=None)
```
- `size_limit`: ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰ï¼ŒNoneåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶å€¼
- `time_limit`: ç¼“å­˜æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰ï¼ŒNoneåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶å€¼

#### ä¸»è¦æ–¹æ³•

##### put(text, voice, speed, audio_segment)
å­˜å‚¨éŸ³é¢‘åˆ°ç¼“å­˜
- `text`: æ–‡æœ¬å†…å®¹
- `voice`: è¯­éŸ³ç±»å‹
- `speed`: è¯­é€Ÿ
- `audio_segment`: AudioSegmentå¯¹è±¡

##### get(text, voice, speed)
ä»ç¼“å­˜è·å–éŸ³é¢‘
- è¿”å›: AudioSegmentå¯¹è±¡æˆ–None

##### get_stats()
è·å–è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
- è¿”å›: åŒ…å«ç»Ÿè®¡æ•°æ®çš„å­—å…¸

##### get_cache_entries_info()
è·å–æ‰€æœ‰ç¼“å­˜æ¡ç›®ä¿¡æ¯
- è¿”å›: æ¡ç›®ä¿¡æ¯åˆ—è¡¨

##### clear()
æ¸…ç©ºæ‰€æœ‰ç¼“å­˜

##### optimize()
ä¼˜åŒ–ç¼“å­˜æ€§èƒ½
- è¿”å›: ä¼˜åŒ–ç»“æœç»Ÿè®¡

## ç»Ÿè®¡ä¿¡æ¯è¯´æ˜

### åŸºæœ¬ç»Ÿè®¡
- `hits`: ç¼“å­˜å‘½ä¸­æ¬¡æ•°
- `misses`: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
- `evictions`: æ¡ç›®æ·˜æ±°æ¬¡æ•°
- `total_requests`: æ€»è¯·æ±‚æ¬¡æ•°
- `entry_count`: å½“å‰æ¡ç›®æ•°
- `total_size_bytes`: å½“å‰æ€»å¤§å°

### è®¡ç®—ç»Ÿè®¡
- `hit_rate`: å‘½ä¸­ç‡ (0.0-1.0)
- `memory_usage_percent`: å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”
- `average_entry_size`: å¹³å‡æ¡ç›®å¤§å°
- `oldest_entry_age`: æœ€æ—§æ¡ç›®å¹´é¾„ï¼ˆç§’ï¼‰

### æ•ˆç‡æŒ‡æ ‡
- `hit_rate_percent`: å‘½ä¸­ç‡ç™¾åˆ†æ¯”
- `memory_utilization_percent`: å†…å­˜åˆ©ç”¨ç‡ç™¾åˆ†æ¯”
- `average_entry_size_kb`: å¹³å‡æ¡ç›®å¤§å°ï¼ˆKBï¼‰
- `entries_per_mb`: æ¯MBçš„æ¡ç›®æ•°

## é…ç½®é›†æˆ

ç¼“å­˜ç³»ç»Ÿä¸é…ç½®ç®¡ç†å™¨é›†æˆï¼Œæ”¯æŒä»¥ä¸‹é…ç½®é¡¹ï¼š

```json
{
  "tts": {
    "cache_size_limit": 10485760,  // 10MB
    "cache_time_limit": 1200       // 20åˆ†é’Ÿ
  }
}
```

é…ç½®æ›´æ–°ä¼šè‡ªåŠ¨åº”ç”¨åˆ°è¿è¡Œä¸­çš„ç¼“å­˜å®ä¾‹ã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç¼“å­˜å¤§å°è®¾ç½®
- **å°å‹åº”ç”¨**: 1-10MB
- **ä¸­å‹åº”ç”¨**: 10-100MB  
- **å¤§å‹åº”ç”¨**: 100MB-1GB

### æ—¶é—´é™åˆ¶è®¾ç½®
- **å¼€å‘ç¯å¢ƒ**: 5-10åˆ†é’Ÿ
- **ç”Ÿäº§ç¯å¢ƒ**: 20-60åˆ†é’Ÿ
- **é•¿æœŸç¼“å­˜**: 2-24å°æ—¶

### ç›‘æ§æŒ‡æ ‡
- **å‘½ä¸­ç‡**: ç›®æ ‡ >70%
- **å†…å­˜ä½¿ç”¨**: ä¿æŒ <90%
- **æ·˜æ±°é¢‘ç‡**: ç›‘æ§å¼‚å¸¸å¢é•¿

## çº¿ç¨‹å®‰å…¨

ç¼“å­˜ç³»ç»Ÿä½¿ç”¨ `threading.RLock` ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒï¼š
- å¹¶å‘è¯»å–æ“ä½œ
- å¹¶å‘å†™å…¥æ“ä½œ
- æ··åˆè¯»å†™æ“ä½œ

## é”™è¯¯å¤„ç†

ç³»ç»ŸåŒ…å«å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š
- æ— æ•ˆéŸ³é¢‘å¯¹è±¡æ£€æµ‹
- é…ç½®é”™è¯¯æ¢å¤
- å†…å­˜ä¸è¶³ä¿æŠ¤
- å¼‚å¸¸æ—¥å¿—è®°å½•

## æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š
```bash
./venv/bin/python3 -m unittest tests.test_audio_cache -v
```

è¿è¡Œç¤ºä¾‹ä»£ç ï¼š
```bash
./venv/bin/python3 audio_cache/example_usage.py
```

## æ—¥å¿—è®°å½•

ç¼“å­˜ç³»ç»Ÿä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•æ‰€æœ‰é‡è¦æ“ä½œï¼š
- ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­
- æ¡ç›®æ·»åŠ /ç§»é™¤
- é…ç½®æ›´æ–°
- ä¼˜åŒ–æ“ä½œ
- é”™è¯¯æƒ…å†µ

æ—¥å¿—çº§åˆ«ï¼š
- `DEBUG`: è¯¦ç»†æ“ä½œä¿¡æ¯
- `INFO`: é‡è¦çŠ¶æ€å˜æ›´
- `WARNING`: æ½œåœ¨é—®é¢˜
- `ERROR`: é”™è¯¯æƒ…å†µ

## æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®ç¼“å­˜å¤§å°
```python
# æ ¹æ®å¯ç”¨å†…å­˜è®¾ç½®åˆç†çš„ç¼“å­˜å¤§å°
available_memory = get_available_memory()
cache_size = min(available_memory * 0.1, 100 * 1024 * 1024)  # 10%æˆ–100MB
```

### 2. ç›‘æ§ç¼“å­˜æ€§èƒ½
```python
# å®šæœŸæ£€æŸ¥ç¼“å­˜ç»Ÿè®¡
stats = cache.get_stats()
if stats['hit_rate'] < 0.5:
    logger.warning("ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼Œè€ƒè™‘è°ƒæ•´é…ç½®")
```

### 3. é€‚æ—¶ä¼˜åŒ–ç¼“å­˜
```python
# åœ¨å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜æ—¶æ‰§è¡Œä¼˜åŒ–
stats = cache.get_stats()
if stats['memory_usage_percent'] > 85:
    cache.optimize()
```

### 4. å¤„ç†é…ç½®æ›´æ–°
```python
# ç›‘å¬é…ç½®å˜æ›´
def on_config_change(key, value):
    if key.startswith('tts.cache'):
        logger.info(f"ç¼“å­˜é…ç½®å·²æ›´æ–°: {key} = {value}")

config_manager.add_watcher(on_config_change)
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - å‡å°‘ `cache_size_limit`
   - ç¼©çŸ­ `cache_time_limit`
   - æ‰§è¡Œ `cache.optimize()`

2. **å‘½ä¸­ç‡è¿‡ä½**
   - æ£€æŸ¥ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘
   - å¢åŠ ç¼“å­˜å¤§å°
   - å»¶é•¿è¿‡æœŸæ—¶é—´

3. **æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥å¹¶å‘è®¿é—®æ¨¡å¼
   - ç›‘æ§é”ç«äº‰
   - ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

### è°ƒè¯•ä¿¡æ¯

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```python
import logging
logging.getLogger('audio_cache').setLevel(logging.DEBUG)
```

è·å–è¯Šæ–­ä¿¡æ¯ï¼š
```python
# è·å–è¯¦ç»†ç»Ÿè®¡
stats = cache.get_stats()
entries = cache.get_cache_entries_info()

# æ£€æŸ¥ç¼“å­˜çŠ¶æ€
print(f"ç¼“å­˜å¥åº·åº¦: {stats['hit_rate']:.2%}")
print(f"å†…å­˜å‹åŠ›: {stats['memory_usage_percent']:.1f}%")
```